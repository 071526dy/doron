<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Doron System - Registration</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #06C755;
      --primary-hover: #05b34c;
      --bg-dark: #0f172a;
      --card-bg: rgba(30, 41, 59, 0.6);
      --card-border: rgba(255, 255, 255, 0.08);
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --accent: #38bdf8;
      --danger: #ef4444;
      --success: #10b981;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Outfit', sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: var(--text-main);
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem 1rem;
    }

    .container {
      width: 100%;
      max-width: 800px;
      animation: fadeIn 0.5s ease-out;
      padding-bottom: 5rem;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    header {
      text-align: center;
      margin-bottom: 3rem;
    }

    h1 {
      font-size: 2.5rem;
      margin: 0;
      font-weight: 600;
      letter-spacing: -1px;
    }

    h1 span {
      color: var(--accent);
    }

    .subtitle {
      color: var(--text-muted);
      margin-top: 0.5rem;
    }

    section {
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 24px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
      width: 100%;
    }

    h2 {
      font-size: 1.25rem;
      margin-top: 0;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: var(--accent);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 1.5rem;
      align-items: stretch;
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-muted);
    }

    input,
    select,
    textarea {
      width: 100%;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 0.75rem 1rem;
      color: white;
      font-family: inherit;
      transition: all 0.2s;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(15, 23, 42, 0.8);
      box-shadow: 0 0 0 4px rgba(56, 189, 248, 0.1);
    }

    .info-box,
    .form-card {
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 16px;
      padding: 1.25rem;
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 1rem;
      transition: all 0.2s;
      min-height: 100px;
      width: 100%;
      height: 100%;
    }

    .info-box:hover {
      border-color: rgba(56, 189, 248, 0.2);
    }

    .info-content {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .info-actions {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-shrink: 0;
      margin-left: auto;
    }

    .info-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .info-value {
      font-weight: 600;
      font-size: 0.9rem;
      word-break: break-all;
      line-height: 1.3;
      color: var(--text-main);
    }

    .badge {
      padding: 0.25rem 0.75rem;
      border-radius: 99px;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .badge-success {
      background: rgba(16, 185, 129, 0.15);
      color: #34d399;
      border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .badge-warn {
      background: rgba(245, 158, 11, 0.15);
      color: #fbbf24;
      border: 1px solid rgba(245, 158, 11, 0.2);
    }

    .btn {
      cursor: pointer;
      border: none;
      border-radius: 14px;
      padding: 0.75rem 1.75rem;
      font-weight: 600;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-flex;
      align-items: center;
      gap: 0.6rem;
      justify-content: center;
      font-size: 0.95rem;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      box-shadow: 0 4px 14px 0 rgba(6, 199, 85, 0.3);
    }

    .btn-primary:hover {
      background: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(6, 199, 85, 0.4);
    }

    .btn-outline {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: var(--text-main);
    }

    .btn-outline:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.3);
      transform: translateY(-1px);
    }

    .btn-accent {
      background: var(--accent);
      color: var(--bg-dark);
      box-shadow: 0 4px 14px 0 rgba(56, 189, 248, 0.3);
    }

    .btn-accent:hover {
      opacity: 0.95;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(56, 189, 248, 0.4);
    }

    .message-item {
      background: rgba(15, 23, 42, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 20px;
      padding: 1.75rem;
      margin-bottom: 1.25rem;
      position: relative;
      transition: border-color 0.2s;
    }

    .message-item:hover {
      border-color: rgba(56, 189, 248, 0.15);
    }

    .btn-remove {
      position: absolute;
      top: 1rem;
      right: 1rem;
      color: #ef4444;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      border-radius: 8px;
      cursor: pointer;
      padding: 4px 8px;
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.2s;
    }

    .btn-remove:hover {
      background: rgba(239, 68, 68, 0.2);
      opacity: 1;
    }

    .footer-actions {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      margin-top: 2rem;
      margin-bottom: 6rem;
    }

    #toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      background: #4ade80;
      color: #064e3b;
      padding: 1rem 2rem;
      border-radius: 99px;
      font-weight: 600;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      display: none;
      z-index: 100;
    }

    .status-banner {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.2);
      color: #34d399;
      padding: 1.25rem;
      border-radius: 18px;
      margin-bottom: 2.5rem;
      text-align: center;
      font-weight: 600;
      animation: slideDown 0.4s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Device Toggle Styles */
    .device-option {
      cursor: pointer;
    }

    .device-option.active {
      border-color: var(--accent) !important;
      background: rgba(56, 189, 248, 0.1) !important;
    }

    .device-option.active .info-value {
      color: var(--accent);
    }

    .device-option.active .selection-indicator {
      display: block !important;
    }

    .selection-indicator {
      display: none;
      color: var(--accent);
      font-weight: bold;
    }

    .device-option:hover:not(.active) {
      background: rgba(255, 255, 255, 0.07);
    }

    .device-option .icon {
      font-size: 1.5rem;
      display: block;
      margin-bottom: 0.5rem;
    }

    /* Checklist Styles */
    .iphone-checklist {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 16px;
      padding: 1.5rem;
    }

    .checklist-item {
      display: flex;
      align-items: flex-start;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .checklist-item:last-child {
      margin-bottom: 0;
    }

    .checklist-text {
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .checklist-text b {
      display: block;
      color: var(--text-main);
      margin-bottom: 0.2rem;
    }

    .checklist-text span {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .btn-switch-account {
      display: flex !important;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      gap: 0.5rem;
      background: rgba(255, 255, 255, 0.05);
      padding: 0.75rem 1rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      color: var(--text-muted);
      font-size: 0.85rem;
      transition: all 0.2s;
      width: 100%;
      margin-top: 1rem;
      cursor: pointer;
    }

    .btn-switch-account:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: var(--accent);
      color: var(--accent);
    }
  </style>
</head>

<body>

  <div id="heartbeat"
    style="position:fixed; top:0; left:0; padding:5px; background:#38bdf8; color:white; z-index:10000; font-size:10px; font-weight:bold; border-bottom-right-radius:8px;">
    v191 CANONICAL</div>
  <script>
    console.log("SPA index.html v191 CANONICAL - Entry point safe.");
    window.onerror = function (msg, url, line) {
      console.error("Browser Error: " + msg + " at " + url + ":" + line);
      try { document.getElementById('heartbeat').innerText = 'v191 FAIL: ' + msg; } catch (e) { }
    };
    try {
      document.getElementById('heartbeat').innerText = 'v191 (Armed)';
    } catch (e) { }
  </script>

  <!-- LOGIN OVERLAY (SPA) -->
  <div id="login-overlay"
    style="position:fixed; top:0; left:0; width:100%; height:100%; background:linear-gradient(135deg, #0f172a 0%, #1e293b 100%); z-index:9000; display:flex; align-items:center; justify-content:center; padding:1rem;">
    <div
      style="width:100%; max-width:480px; background:rgba(30, 41, 59, 0.7); backdrop-filter:blur(12px); border:1px solid rgba(255,255,255,0.1); border-radius:24px; padding:2.5rem; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3);">

      <!-- Domain Warning Bar -->
      <div id="domain-warning"
        style="display:none; background:#ef4444; color:white; padding:0.75rem; border-radius:12px; margin-bottom:1.5rem; font-size:0.85rem; text-align:center; font-weight:bold;">
        âš ï¸ ä¸é©åˆ‡ãªãƒ‰ãƒ¡ã‚¤ãƒ³ã§ã™ã€‚<br>
        <a id="canonical-redirect-link" href="#" target="_top"
          style="color:white; text-decoration:underline;">ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ¨å¥¨URLã¸ç§»å‹•</a>
      </div>

      <div style="text-align:center; margin-bottom:2rem;">
        <h1 style="font-size:2.5rem; margin:0; font-weight:600; letter-spacing:-1px;">ğŸ‘» Doron <span>System</span></h1>
        <p style="color:var(--text-muted); margin-top:0.5rem; font-size:0.9rem;">ç”Ÿå­˜ç¢ºèªãŠã‚ˆã³éºè¨€è‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ </p>
      </div>

      <!-- Auth Guidance (Aggressive) -->
      <div id="auth-guidance"
        style="display:none; background:rgba(56, 189, 248, 0.1); border:1px solid var(--accent); border-radius:16px; padding:1.25rem; margin-bottom:2rem; animation: pulse 2s infinite;">
        <p style="margin:0 0 0.5rem 0; color:var(--accent); font-weight:bold; font-size:0.95rem;">â˜ï¸ å¯¾å¿œãŒå¿…è¦ã§ã™</p>
        <p style="margin:0; font-size:0.8rem; color:var(--text-main); line-height:1.4;">
          ãƒ–ãƒ©ã‚¦ã‚¶ã®ä¸€ç•ªä¸Šï¼ˆã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã®ã™ãä¸‹ï¼‰ã«é’ã„ãƒœã‚¿ãƒ³ãŒå‡ºã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ
          <b>ãã‚Œã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ‰¿èªã‚’å®Œäº†ã•ã›ã¦ãã ã•ã„ã€‚</b>
        </p>
      </div>

      <div id="loading-hint" style="text-align:center; margin-bottom: 2rem;">
        <div
          style="display:inline-block; width:20px; height:20px; border:3px solid rgba(255,255,255,0.1); border-top-color:var(--accent); border-radius:50%; animation: spin 1s linear infinite; margin-bottom:0.5rem;">
        </div>
        <p id="loading-text" style="color:var(--text-muted); font-size:0.85rem; margin:0;">åˆæœŸåŒ–ä¸­...</p>
      </div>
      <style>
        @keyframes spin {
          to {
            transform: rotate(360deg);
          }
        }

        @keyframes pulse {

          0%,
          100% {
            border-color: var(--accent);
            box-shadow: 0 0 0px var(--accent);
          }

          50% {
            border-color: white;
            box-shadow: 0 0 15px var(--accent);
          }
        }
      </style>

      <!-- SPA Login Section -->
      <div id="spa-login-section" style="display:none;">
        <div id="spa-account-info"
          style="background:rgba(0,0,0,0.2); border-radius:12px; padding:1rem; margin-bottom:1.5rem; text-align:center;">
          <div style="font-size:0.75rem; color:var(--text-muted); margin-bottom:0.5rem;">Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</div>
          <div id="spa-email" style="font-weight:600; color:var(--accent); font-size:0.95rem;">
            <?= userEmail ?>
          </div>
          <a href="<?= switchAccountUrl ?>" target="_top" class="btn-switch-account"
            style="margin-top:0.75rem; display:inline-flex; align-items:center; justify-content:center; text-decoration:none; gap:0.5rem; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); padding:0.5rem 1rem; border-radius:8px; color:var(--text-muted); font-size:0.75rem;">
            ğŸ”„ åˆ¥ã®Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³
          </a>
        </div>

        <div id="spa-error" class="error-message"
          style="display:none; background:rgba(239,68,68,0.1); border:1px solid rgba(239,68,68,0.3); border-radius:12px; padding:1rem; margin-bottom:1.5rem; color:#fca5a5; font-size:0.875rem;">
        </div>

        <form id="spa-login-form" onsubmit="handleSpaLogin(event)">
          <div class="form-group">
            <label id="spa-pass-label">
              <?= isFirstTime ? 'æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®š' : 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰' ?>
            </label>
            <input type="password" id="spa-password" placeholder="<?= isFirstTime ? 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãã ã•ã„' : 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›' ?>"
              required
              style="width:100%; background:rgba(15,23,42,0.6); border:1px solid rgba(255,255,255,0.1); border-radius:12px; padding:0.875rem 1rem; color:white;">
          </div>
          <button type="submit" id="spa-login-btn" class="btn btn-primary" style="width:100%;">
            <span>ğŸ”</span> <span id="spa-btn-text">
              <?= isFirstTime ? 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦é–‹å§‹' : 'ãƒ­ã‚°ã‚¤ãƒ³' ?>
            </span>
          </button>
        </form>

        <!-- Troubleshooting Toggle -->
        <button onclick="toggleDiag()"
          style="margin-top:1.5rem; background:transparent; border:none; color:var(--text-muted); font-size:0.75rem; cursor:pointer; width:100%; text-align:center; text-decoration:underline;">
          [+] ãƒˆãƒ©ãƒ–ãƒ«è¨ºæ–­æƒ…å ±ã‚’è¡¨ç¤º
        </button>
        <div id="diag-box"
          style="margin-top:1rem; padding:1rem; background:rgba(0,0,0,0.2); border-radius:12px; font-size:0.75rem; color:var(--text-muted); display:none;">
          <div id="diag-content"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="container" id="main-content" style="visibility:hidden;">
    <header>
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h1>ğŸ‘» Doron <span>System</span></h1>
          <p class="subtitle">ç”Ÿå­˜ç¢ºèªãŠã‚ˆã³éºè¨€è‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</p>
        </div>
        <button onclick="handleLogout()" class="btn btn-outline"
          style="width: auto; padding: 0.5rem 1rem; font-size: 0.85rem;">
          ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        </button>
      </div>
    </header>

    <div id="status-banner" class="status-banner" style="display:none;"></div>

    <!-- 1. Account Settings -->
    <section>
      <h2>ğŸ‘¤ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±</h2>
      <div class="grid">
        <div class="info-box">
          <div class="info-content">
            <span class="info-label">Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</span>
            <span class="info-value" id="disp-email">Loading...</span>
          </div>
          <div class="info-actions">
            <span class="badge badge-success">èªè¨¼æ¸ˆã¿</span>
            <button onclick="handleChangeGoogleAccount()" class="btn btn-outline btn-small"
              style="padding: 4px 10px; font-size: 0.75rem; width: auto; min-width: 60px;">å¤‰æ›´</button>
          </div>
        </div>

        <div class="info-box">
          <div class="info-content">
            <span class="info-label">LINE ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ (ID)</span>
            <span class="info-value" id="disp-line-id">Loading...</span>
          </div>
          <div class="info-actions">
            <button onclick="handleLogin()" class="btn btn-primary" id="line-connect-btn"
              style="padding: 6px 12px; font-size: 0.8rem; width: auto; display: none;">é€£æºã™ã‚‹</button>
            <button onclick="handleDisconnect()" class="btn btn-outline" id="line-disconnect-btn"
              style="padding: 6px 12px; font-size: 0.8rem; width: auto; color: var(--danger); border-color: rgba(239, 68, 68, 0.3); display: none;">è§£é™¤ã™ã‚‹</button>
          </div>
        </div>
      </div>
    </section>

    <!-- 2. Core Trigger Settings -->
    <section>
      <h2>ğŸš¨ ç·Šæ€¥ãƒˆãƒªã‚¬ãƒ¼è¨­å®š</h2>
      <div class="grid">
        <div class="form-card">
          <div class="info-content">
            <span class="info-label">ç·Šæ€¥èµ·å‹• (Webç‰ˆ)</span>
            <div style="font-size: 0.85rem; margin-top: 0.5rem;">
              <a id="trigger-page-link" href="#" target="_blank"
                style="color: var(--accent); text-decoration: underline; word-break: break-all; font-weight: 600;"></a>
            </div>
            <span style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.5rem;">
              â€»ã“ã®URLã‚’ã‚­ãƒ¼ãƒãƒ³ï¼ˆéºæ—ãªã©ï¼‰ã«å…±æœ‰ã—ã¦ãã ã•ã„ã€‚
            </span>
          </div>
        </div>

        <div class="form-card">
          <div class="info-content" style="width: 100%;">
            <span class="info-label">ç·Šæ€¥èµ·å‹•ãƒ‘ã‚¹ã‚­ãƒ¼</span>
            <div style="position: relative; margin-top: 0.5rem;">
              <input type="password" id="passkey" value="" placeholder="åˆè¨€è‘‰" style="background: rgba(0,0,0,0.3);">
              <button type="button" onclick="togglePasskey()" id="passkey-toggle"
                style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text-muted); font-size: 1.2rem;">ğŸ‘ï¸</button>
            </div>
          </div>
        </div>
      </div>
      <p style="margin-top: 1.25rem; font-size: 0.75rem; color: var(--text-muted); text-align: center;">
        â€»åˆè¨€è‘‰ãŒå…¥åŠ›ã•ã‚Œã‚‹ã¨ã€ç™»éŒ²ã•ã‚ŒãŸå…¨å“¡ã¸å³åº§ã«é€šçŸ¥ãŒé£›ã³ã¾ã™ã€‚<br>
        <span style="color: var(--accent);">â€»åˆè¨€è‘‰ã¯ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã§é‡è¤‡ã§ãã¾ã›ã‚“ã€‚ä»–ã®äººã¨è¢«ã‚‰ãªã„é•·ã„è¨€è‘‰ã‚’æ¨å¥¨ã—ã¾ã™ã€‚</span>
      </p>
    </section>

    <!-- 3. Device Protection Settings -->
    <section>
      <h2>ğŸ“± ãƒ‡ãƒã‚¤ã‚¹ä¿è­·è¨­å®š (é éš”åˆæœŸåŒ–)</h2>

      <div class="grid device-selector">
        <div class="info-box device-option" id="opt-android" onclick="setDeviceType('android')">
          <div class="info-content">
            <span class="info-label">ã‚¹ãƒãƒ›ã®ç¨®é¡</span>
            <span class="info-value">ğŸ¤– Android</span>
          </div>
          <div class="info-actions">
            <span class="selection-indicator">é¸æŠä¸­</span>
          </div>
        </div>
        <div class="info-box device-option" id="opt-iphone" onclick="setDeviceType('iphone')">
          <div class="info-content">
            <span class="info-label">ã‚¹ãƒãƒ›ã®ç¨®é¡</span>
            <span class="info-value">ğŸ iPhone (iOS)</span>
          </div>
          <div class="info-actions">
            <span class="selection-indicator">é¸æŠä¸­</span>
          </div>
        </div>
      </div>

      <!-- Android Specific -->
      <div id="device-config-android" style="display: none;">
        <div class="form-group" style="margin-bottom: 0;">
          <label for="macrodroidWebhookUrl">ã‚¹ãƒãƒ›é éš”åˆæœŸåŒ–ã®URL (MacroDroid)</label>
          <input type="text" id="macrodroidWebhookUrl" value="" placeholder="https://trigger.macrodroid.com/...">
        </div>
      </div>

      <!-- iPhone Specific -->
      <div id="device-config-iphone" style="display: none;">
        <div class="iphone-checklist">
          <p style="font-size: 0.85rem; margin-top:0; margin-bottom:1rem; color: var(--accent); font-weight:600;">
            ğŸ iPhoneã®ä¿è­·è¨­å®šï¼ˆæ¨å¥¨ï¼‰
          </p>

          <div class="checklist-item">
            <input type="checkbox" style="width: auto; margin-top: 3px;" checked disabled>
            <div class="checklist-text">
              <b>ã€Œãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ï¼ˆ10å›å¤±æ•—æ™‚ï¼‰ã€ã‚’ONã«ã™ã‚‹</b>
              <span>[è¨­å®š] > [Face IDã¨ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰] <br>â€»10å›ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’é–“é•ãˆã‚‹ã¨ãƒ‡ãƒ¼ã‚¿ãŒå…¨æ¶ˆå»ã•ã‚Œã¾ã™ã€‚</span>
            </div>
          </div>

          <div class="checklist-item">
            <input type="checkbox" style="width: auto; margin-top: 3px;" checked disabled>
            <div class="checklist-text">
              <b>ã€Œæ•…äººã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†é€£çµ¡å…ˆã€ã‚’å‰Šé™¤ã™ã‚‹</b>
              <span>[è¨­å®š] > [Apple ID] > [ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£] <br>â€»è¨­å®šã•ã‚Œã¦ã„ã‚‹ã¨éºæ—ã«ãƒ­ãƒƒã‚¯è§£é™¤ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</span>
            </div>
          </div>

          <div class="checklist-item">
            <input type="checkbox" style="width: auto; margin-top: 3px;" checked disabled>
            <div class="checklist-text">
              <b>Face ID / Touch ID ã‚’OFFã«ã™ã‚‹</b>
              <span>[è¨­å®š] > [Face IDã¨ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰] <br>â€»ç”Ÿä½“èªè¨¼ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã€ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã®ã¿ã«ã—ã¾ã™ã€‚å¯ã¦ã„ã‚‹é–“ã«è§£é™¤ã•ã‚Œã‚‹ãƒªã‚¹ã‚¯ã‚’é˜²ãã¾ã™ã€‚</span>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- 4. Grace Period Settings -->
    <section>
      <h2>â±ï¸ åŸ·è¡ŒçŒ¶äºˆè¨­å®š</h2>
      <div class="grid">
        <div class="form-card">
          <div class="info-content">
            <span class="info-label">çŒ¶äºˆæœŸé–“ (æ™‚é–“)</span>
            <div style="display: flex; gap: 1rem; align-items: center; margin-top: 0.5rem;">
              <input type="number" id="gracePeriodHours" value="24" min="1" max="168"
                style="max-width: 120px; background: rgba(0,0,0,0.3);">
              <span style="color: var(--text-muted); font-weight: 600;">æ™‚é–“</span>
            </div>
          </div>
        </div>
        <div class="info-box" style="pointer-events: none; border: none; background: none; box-shadow: none;">
          <div class="info-content">
            <span style="font-size: 0.8rem; color: var(--text-muted); line-height: 1.5;">
              â€»ç”Ÿå­˜ç¢ºèªã®é€£çµ¡ã«å¯¾ã—ã€ã“ã®æ™‚é–“å†…ã«åå¿œãŒãªã„ã¨å…¨è‡ªå‹•ã§éºè¨€é€ä¿¡ãƒ»æ¶ˆå»ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
            </span>
          </div>
        </div>
      </div>
    </section>

    <!-- 5. Last Messages -->
    <section id="messages-section">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h2 style="margin-bottom: 0;">ğŸ’Œ éºè¨€ãƒ»æœ€çµ‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h2>
        <button onclick="addMessageRow()" class="btn btn-outline btn-small"
          style="padding: 0.5rem 1.25rem; font-size: 0.85rem; width: auto;">
          <span>+</span> è¿½åŠ 
        </button>
      </div>
      <div id="messages-list"></div>
    </section>

    <!-- 6. Operation Tests -->
    <section>
      <h2>ğŸ¥’ å‹•ä½œãƒ†ã‚¹ãƒˆ (å®‰å…¨ç¢ºèª)</h2>
      <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 1.5rem;">
        ä¿å­˜æ¸ˆã¿ã®è¨­å®šãŒæ­£ã—ãå‹•ãã‹ã€å®Ÿéš›ã«ä»–äººã«é€šçŸ¥ã‚’é€ã‚‰ãšã«ãƒ†ã‚¹ãƒˆã§ãã¾ã™ã€‚
      </p>

      <div class="grid">
        <button onclick="runTest('verifyLineConnection')" class="btn btn-outline" style="justify-content: center;">
          ğŸ“± LINEé€£æºãƒ†ã‚¹ãƒˆ
        </button>
        <button onclick="runTest('simulateEmergencyTrigger')" class="btn btn-outline" style="justify-content: center;">
          ğŸš¨ èµ·å‹•ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        </button>
      </div>

      <div style="margin-top: 1rem;">
        <button onclick="runTest('simulateLastMessages')" class="btn btn-outline"
          style="width: 100%; justify-content: center;">
          ğŸ“§ éºè¨€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é€ä¿¡
        </button>
      </div>

      <p id="test-result-msg" style="margin-top: 1rem; font-size: 0.85rem; color: var(--accent); min-height: 1.2em;">
      </p>
    </section>

    <div class="footer-actions">
      <button class="btn btn-outline" onclick="restoreData()" style="min-width: 140px;">
        <span>â†©ï¸</span> ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ
      </button>
      <button class="btn btn-primary" onclick="handleSave(this)" id="save-btn" style="flex: 1; max-width: 400px;">
        <span>ğŸ’¾</span> è¨­å®šã‚’ä¿å­˜ã—ã¦é©ç”¨ã™ã‚‹
      </button>
    </div>
  </div>

  <div id="toast">ä¿å­˜ã•ã‚Œã¾ã—ãŸ</div>

  <script>
    const INJECTED_SESSION_TOKEN = '<?!= sessionToken ?>';
    const SCRIPT_URL = '<?!= scriptUrl ?>';
    let currentSessionToken = '';
    let diagData = null;

    // 1. Initial Load Sequence
    window.onload = function () {
      detectDomainMismatch();

      let sToken = INJECTED_SESSION_TOKEN || '';
      if (!sToken) {
        const urlParams = new URLSearchParams(window.location.search);
        sToken = urlParams.get('session') || '';
      }
      currentSessionToken = sToken;

      initAuthCheck(sToken);
    };

    function detectDomainMismatch() {
      const currentUrl = window.location.href;
      // If URL contains /a/ (Workspace) but we want canonical (script.google.com/macros/s/...)
      if (currentUrl.includes('/a/')) {
        document.getElementById('domain-warning').style.display = 'block';
        const redirectLink = document.getElementById('canonical-redirect-link');
        redirectLink.href = SCRIPT_URL;
      }
    }

    function initAuthCheck(token) {
      console.log("SPA: Initializing Auth Check...");

      // If auth check takes too long, show the "Action Required" guidance
      const authTimeout = setTimeout(() => {
        if (!diagData) {
          document.getElementById('auth-guidance').style.display = 'block';
          document.getElementById('loading-text').innerText = 'æ¥ç¶šå¾…æ©Ÿä¸­ (æ‰¿èªç¢ºèªã‚’ãŠé¡˜ã„ã—ã¾ã™)';
        }
      }, 3000);

      google.script.run
        .withSuccessHandler((res) => {
          clearTimeout(authTimeout);
          diagData = res;
          handleAuthResponse(res, token);

          // Update canonical link in warning if available
          if (res.canonicalUrl) {
            const redirectLink = document.getElementById('canonical-redirect-link');
            if (redirectLink) redirectLink.href = res.canonicalUrl;
          }
        })
        .withFailureHandler((err) => {
          clearTimeout(authTimeout);
          console.error("Auth status failure:", err);
          document.getElementById('auth-guidance').style.display = 'block';
          document.getElementById('loading-text').innerText = 'ã‚¨ãƒ©ãƒ¼ã«ã‚ˆã‚Šåœæ­¢: ' + err.message;
        })
        .getAuthStatus(token);
    }

    function handleAuthResponse(res, sentToken) {
      document.getElementById('loading-hint').style.display = 'none';
      document.getElementById('auth-guidance').style.display = 'none';

      if (res.authenticated) {
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('main-content').style.visibility = 'visible';

        // Update labels based on user response
        document.getElementById('spa-email').innerText = res.userEmail;

        google.script.run.withSuccessHandler(initApp).getSettings(sentToken);
      } else {
        document.getElementById('login-overlay').style.display = 'flex';
        document.getElementById('spa-login-section').style.display = 'block';

        // Update first-time setup text
        if (res.isFirstTime) {
          document.getElementById('spa-pass-label').innerText = 'æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®š';
          document.getElementById('spa-password').placeholder = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãã ã•ã„';
          document.getElementById('spa-btn-text').innerText = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦é–‹å§‹';
        } else {
          document.getElementById('spa-pass-label').innerText = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰';
          document.getElementById('spa-password').placeholder = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›';
          document.getElementById('spa-btn-text').innerText = 'ãƒ­ã‚°ã‚¤ãƒ³';
        }
      }
    }

    // 2. Login Logic
    function handleSpaLogin(event) {
      event.preventDefault();
      const password = document.getElementById('spa-password').value.trim();
      const btn = document.getElementById('spa-login-btn');
      const errorDiv = document.getElementById('spa-error');

      btn.disabled = true;
      errorDiv.style.display = 'none';

      google.script.run
        .withSuccessHandler((result) => {
          if (result.success) {
            currentSessionToken = result.sessionToken;
            // Update URL for refreshing without re-login
            if (google.script.history) {
              google.script.history.push({}, { session: result.sessionToken }, '');
            }
            handleAuthResponse({ authenticated: true }, result.sessionToken);
          } else {
            errorDiv.innerText = result.message || 'ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—';
            errorDiv.style.display = 'block';
            btn.disabled = false;
          }
        })
        .withFailureHandler((err) => {
          errorDiv.innerText = "é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + err.message;
          errorDiv.style.display = 'block';
          btn.disabled = false;
        })
        .authenticateUser(password);
    }

    // 3. App Initialization
    function initApp(config) {
      document.getElementById('disp-email').innerText = config.userEmail || "Anonymous";
      document.getElementById('passkey').value = config.passkey || '';
      document.getElementById('macrodroidWebhookUrl').value = config.macrodroidWebhookUrl || '';
      document.getElementById('gracePeriodHours').value = config.gracePeriodHours || 24;
      const isLineSet = (config.userLineId && config.userLineId !== 'NOT_SET');
      document.getElementById('disp-line-id').innerText = (isLineSet ? config.userLineId : 'æœªé€£æº');
      document.getElementById('line-connect-btn').style.display = isLineSet ? 'none' : 'inline-flex';
      document.getElementById('line-disconnect-btn').style.display = isLineSet ? 'inline-flex' : 'none';

      // Trigger URL setup
      const sUrl = config.scriptUrl || SCRIPT_URL || "";
      const triggerPageUrl = sUrl + (sUrl.includes("?") ? "&" : "?") + "page=trigger";
      const triggerLink = document.getElementById('trigger-page-link');
      if (triggerLink) {
        triggerLink.href = triggerPageUrl;
        triggerLink.innerText = triggerPageUrl;
      }

      setDeviceType(config.deviceType || 'android');
      const list = document.getElementById('messages-list');
      list.innerHTML = '';
      (config.lastMessages || []).forEach(msg => addMessageRow(msg));
      if (list.children.length === 0) addMessageRow();
    }

    // 4. Diagnostic UI
    function toggleDiag() {
      const box = document.getElementById('diag-box');
      const cont = document.getElementById('diag-content');
      if (!box || !cont) return;

      if (box.style.display === 'none') {
        const d = diagData || {};
        cont.innerHTML = `
                <div style="border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:0.5rem; margin-bottom:0.5rem; font-weight:bold; color:var(--accent);">ğŸ” ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­æƒ…å ±</div>
                â€¢ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ: ${d.userEmail || '(å–å¾—ä¸å¯)'}<br>
                â€¢ æ¨©é™çŠ¶æ³:<br>
                  - è¨­å®šä¿å­˜: ${d.permissions?.Properties === true ? 'âœ…OK' : 'âŒNG (' + (d.permissions?.Properties || 'è¦æ‰¿èª') + ')'}<br>
                  - ãƒ‰ãƒ©ã‚¤ãƒ–: ${d.permissions?.Drive === true ? 'âœ…OK' : 'âŒNG'}<br>
                  - æœ‰åŠ¹ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${d.permissions?.EffectiveUser || '-'}<br>
                â€¢ ã‚»ãƒƒã‚·ãƒ§ãƒ³: ${d.authenticated ? 'æœ‰åŠ¹' : 'æœªèªè¨¼'}<br>
                â€¢ æ¥ç¶šå…ˆãƒ‰ãƒ¡ã‚¤ãƒ³: ${window.location.host}
            `;
        box.style.display = 'block';
      } else {
        box.style.display = 'none';
      }
    }

    // --- Original UI Helpers ---

    function addMessageRow(data = { name: '', type: 'LINE', id: '', message: '' }) {
      const list = document.getElementById('messages-list');
      const div = document.createElement('div');
      div.className = 'message-item';
      div.innerHTML = `
        <button class="btn-remove" onclick="if(confirm('é€ä¿¡å…ˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) this.parentElement.remove()">ğŸ—‘ï¸ å‰Šé™¤</button>
        <div class="grid">
          <div class="form-group"><label>å®›å</label><input type="text" class="msg-name" value="${data.name}"></div>
          <div class="form-group"><label>é€šçŸ¥æ‰‹æ®µ</label><select class="msg-type"><option value="LINE" ${data.type === 'LINE' ? 'selected' : ''}>LINE</option><option value="EMAIL" ${data.type === 'EMAIL' ? 'selected' : ''}>Email</option></select></div>
        </div>
        <div class="form-group"><label>é€ä¿¡å…ˆID / Email</label><input type="text" class="msg-id" value="${data.id}"></div>
        <div class="form-group"><label>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡</label><textarea class="msg-content" rows="3">${data.message}</textarea></div>
      `;
      list.appendChild(div);
    }

    function setDeviceType(type) {
      document.getElementById('opt-android').classList.toggle('active', type === 'android');
      document.getElementById('opt-iphone').classList.toggle('active', type === 'iphone');
      document.getElementById('device-config-android').style.display = (type === 'android' ? 'block' : 'none');
      document.getElementById('device-config-iphone').style.display = (type === 'iphone' ? 'block' : 'none');
      window.selectedDeviceType = type;
    }

    function handleSave(btn) {
      btn.disabled = true;
      const messageItems = document.querySelectorAll('.message-item');
      const lastMessages = Array.from(messageItems).map(item => ({
        name: item.querySelector('.msg-name').value,
        type: item.querySelector('.msg-type').value,
        id: item.querySelector('.msg-id').value,
        message: item.querySelector('.msg-content').value
      }));
      const data = {
        passkey: document.getElementById('passkey').value,
        gracePeriodHours: document.getElementById('gracePeriodHours').value,
        deviceType: window.selectedDeviceType,
        macrodroidWebhookUrl: document.getElementById('macrodroidWebhookUrl').value,
        lastMessages: lastMessages
      };
      google.script.run.withSuccessHandler((res) => {
        showToast(res.message);
        btn.disabled = false;
      }).saveSettings(currentSessionToken, data);
    }

    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.innerText = msg;
      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', 3000);
    }

    function runTest(functionName) {
      google.script.run.withSuccessHandler((res) => alert(res.message))[functionName](currentSessionToken);
    }

    function handleLogout() {
      if (confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
        google.script.run.withSuccessHandler((res) => window.top.location.href = res.redirectUrl).logout();
      }
    }

    function handleChangeGoogleAccount() {
      if (window.location.href.includes('/dev')) {
        alert("âš ï¸ é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰(dev)ã®URLã§ã¯ã€ç·¨é›†æ¨©é™ã®ãªã„ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¸åˆ‡ã‚Šæ›¿ãˆã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚\n\nå¿…ãšãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿ã®æœ¬ç•ªç”¨URL(exec)ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚");
      }
      if (confirm("åˆ¥ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¾ã™ã‹ï¼Ÿ")) {
        // Use client-side URL to ensure we return to the exact same deploy
        const currentUrl = window.location.href.split('?')[0];
        const target = "https://accounts.google.com/AccountChooser?service=wise&continue=" + encodeURIComponent(currentUrl);
        window.top.location.href = target;
      }
    }

    function handleLogin(forceLogin = false) {
      google.script.run.withSuccessHandler((url) => window.top.location.replace(url)).getLoginUrl(forceLogin, currentSessionToken);
    }

    function handleDisconnect() {
      if (confirm("LINEé€£æºã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ\nè§£é™¤ã™ã‚‹ã¨ç”Ÿå­˜ç¢ºèªã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå±Šã‹ãªããªã‚Šã¾ã™ã€‚")) {
        google.script.run
          .withSuccessHandler((res) => {
            showToast(res.message);
            // Re-fetch settings to update UI
            google.script.run.withSuccessHandler(initApp).getSettings(currentSessionToken);
          })
          .disconnectLineAccount(currentSessionToken);
      }
    }

    function togglePasskey() {
      const input = document.getElementById('passkey');
      const btn = document.getElementById('passkey-toggle');
      if (input.type === 'password') {
        input.type = 'text';
        btn.innerText = 'ğŸ‘“';
      } else {
        input.type = 'password';
        btn.innerText = 'ğŸ‘ï¸';
      }
    }
  </script>
</body>

</html>