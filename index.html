<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Doron System - Registration</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #06C755;
      --primary-hover: #05b34c;
      --bg-dark: #0f172a;
      --card-bg: rgba(30, 41, 59, 0.7);
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --accent: #38bdf8;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Outfit', sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: var(--text-main);
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem 1rem;
    }

    .container {
      width: 100%;
      max-width: 800px;
      animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    header {
      text-align: center;
      margin-bottom: 3rem;
    }

    h1 {
      font-size: 2.5rem;
      margin: 0;
      font-weight: 600;
      letter-spacing: -1px;
    }

    h1 span {
      color: var(--accent);
    }

    .subtitle {
      color: var(--text-muted);
      margin-top: 0.5rem;
    }

    section {
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 24px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
    }

    h2 {
      font-size: 1.25rem;
      margin-top: 0;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: var(--accent);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-muted);
    }

    input,
    select,
    textarea {
      width: 100%;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 0.75rem 1rem;
      color: white;
      font-family: inherit;
      transition: all 0.2s;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(15, 23, 42, 0.8);
      box-shadow: 0 0 0 4px rgba(56, 189, 248, 0.1);
    }

    .info-box {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 16px;
      padding: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .info-label {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .info-value {
      font-weight: 600;
    }

    .badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .badge-success {
      background: rgba(6, 199, 85, 0.2);
      color: #4ade80;
      border: 1px solid rgba(6, 199, 85, 0.3);
    }

    .badge-warn {
      background: rgba(245, 158, 11, 0.2);
      color: #fbbf24;
      border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .btn {
      cursor: pointer;
      border: none;
      border-radius: 12px;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      justify-content: center;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }

    .btn-outline {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
    }

    .btn-outline:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .btn-accent {
      background: var(--accent);
      color: var(--bg-dark);
    }

    .btn-accent:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .message-item {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      position: relative;
    }

    .btn-remove {
      position: absolute;
      top: 1rem;
      right: 1rem;
      color: #ef4444;
      background: none;
      border: none;
      cursor: pointer;
      padding: 5px;
      opacity: 0.6;
    }

    .btn-remove:hover {
      opacity: 1;
    }

    .footer-actions {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      margin-top: 1rem;
      margin-bottom: 5rem;
    }

    #toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      background: #4ade80;
      color: #064e3b;
      padding: 1rem 2rem;
      border-radius: 99px;
      font-weight: 600;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      display: none;
      z-index: 100;
    }

    .status-banner {
      background: rgba(6, 199, 85, 0.1);
      border: 1px solid rgba(6, 199, 85, 0.3);
      color: #4ade80;
      padding: 1rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      text-align: center;
    }
  </style>
</head>

<body>

  <div class="container">
    <header>
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h1>ğŸ‘» Doron <span>System</span></h1>
          <p class="subtitle">ç”Ÿå­˜ç¢ºèªãŠã‚ˆã³éºè¨€è‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</p>
        </div>
        <button onclick="handleLogout()" class="btn btn-outline"
          style="width: auto; padding: 0.5rem 1rem; font-size: 0.85rem;">
          ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        </button>
      </div>
    </header>

    <? if (statusMessage) { ?>
    <div class="status-banner">
      <?= statusMessage ?>
    </div>
    <? } ?>

    <!-- 1. Account Identity -->
    <section>
      <h2>ğŸ‘¤ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±</h2>
      <div class="grid">
        <div class="info-box" style="justify-content: space-between; align-items: center; display: flex;">
          <div style="flex: 1;">
            <div class="info-label">Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</div>
            <div class="info-value">
              <?= config.userEmail ?>
            </div>
          </div>
          <div style="display: flex; gap: 10px; align-items: center;">
            <span class="badge badge-success">èªè¨¼æ¸ˆã¿</span>
            <button onclick="handleChangeGoogleAccount()" class="btn btn-outline btn-small"
              style="padding: 4px 10px; font-size: 0.75rem; width: auto; min-width: 60px;">å¤‰æ›´</button>
          </div>
        </div>
        <div class="info-box">
          <div>
            <div class="info-label">LINE ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ (ID)</div>
            <div class="info-value" id="disp-line-id">
              <?= config.userLineId === 'NOT_SET' ? 'æœªé€£æº' : config.userLineId ?>
            </div>
          </div>
          <? if (config.userLineId === 'NOT_SET') { ?>
          <button onclick="handleLogin()" class="btn btn-primary btn-small"
            style="padding: 6px 14px; font-size: 0.8rem;">é€£æºã™ã‚‹</button>
          <? } else { ?>
          <span class="badge badge-success">é€£æºæ¸ˆã¿</span>
          <? } ?>
        </div>
      </div>
    </section>

    <!-- 2. Core Trigger Settings -->
    <section>
      <h2>ğŸš¨ ç·Šæ€¥ãƒˆãƒªã‚¬ãƒ¼è¨­å®š</h2>
      <div class="grid">
        <div class="form-group">
          <label for="passkey">ç·Šæ€¥èµ·å‹•ãƒ‘ã‚¹ã‚­ãƒ¼</label>
          <input type="password" id="passkey" value="<?= config.passkey ?>" placeholder="éºè¨€ã®ãƒˆãƒªã‚¬ãƒ¼ã¨ãªã‚‹åˆè¨€è‘‰">
        </div>
        <div style="display: flex; align-items: center; color: var(--text-muted); font-size: 0.85rem;">
          <p>â€»åˆè¨€è‘‰ã«ã‚ˆã£ã¦ã‚·ã‚¹ãƒ†ãƒ ãŒèµ·å‹•ã•ã‚Œã‚‹ã¨ã€ä»¥ä¸‹ã®ã€Œéºè¨€ãƒ»æœ€çµ‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ã«ç™»éŒ²ã•ã‚ŒãŸå…¨å“¡ã¸å³åº§ã«é€šçŸ¥ãŒé£›ã³ã¾ã™ã€‚</p>
        </div>
      </div>
    </section>

    <!-- 3. Execution Settings -->
    <section>
      <h2>âš™ï¸ å®Ÿè¡Œãƒ•ã‚§ãƒ¼ã‚ºè¨­å®š</h2>
      <div class="grid">
        <div class="form-group">
          <label for="gracePeriodHours">çŒ¶äºˆæœŸé–“ (æ™‚é–“)</label>
          <input type="number" id="gracePeriodHours" value="<?= config.gracePeriodHours ?>" min="1" max="168">
          <small style="color: var(--text-muted); font-size: 0.7rem;">ç”Ÿå­˜ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¸ã®å¿œç­”ãŒãªã„å ´åˆã«å®Ÿè¡Œã•ã‚Œã‚‹ã¾ã§ã®æ™‚é–“ã€‚</small>
        </div>
        <div class="form-group">
          <label for="macrodroidWebhookUrl">MacroDroid Webhook URL</label>
          <input type="text" id="macrodroidWebhookUrl" value="<?= config.macrodroidWebhookUrl ?>"
            placeholder="Androidç«¯æœ«ã®åˆæœŸåŒ–ç”¨">
        </div>
      </div>
    </section>

    <!-- 4. Last Messages -->
    <section id="messages-section">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="margin-bottom: 0;">ğŸ’Œ éºè¨€ãƒ»æœ€çµ‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h2>
        <button class="btn btn-outline" onclick="addMessageRow()">ï¼‹ è¿½åŠ </button>
      </div>

      <div id="messages-list">
        <!-- Message Rows will be injected here -->
      </div>
    </section>

    <!-- 5. Advanced (API Keys) -->
    <section>
      <details>
        <summary style="cursor: pointer; color: var(--text-muted); font-size: 0.8rem;">è©³ç´°è¨­å®š (APIã‚­ãƒ¼ç­‰ - å¿…é ˆ)</summary>
        <div style="padding-top: 1rem;">
          <div
            style="background: rgba(56, 189, 248, 0.1); border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem; border: 1px solid rgba(56, 189, 248, 0.2);">
            <p style="margin: 0; font-size: 0.85rem; color: var(--accent);">
              ğŸ’¡ <b>ã©ã“ã§ç¢ºèªã§ãã¾ã™ã‹ï¼Ÿ</b><br>
              <a href="https://developers.line.biz/console/" target="_blank"
                style="color: white; text-decoration: underline;">LINE Developers Console</a> ã‹ã‚‰å„ãƒãƒ£ãƒãƒ«ï¼ˆMessaging API /
              LINE Loginï¼‰ã®åŸºæœ¬æƒ…å ±ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
            </p>
          </div>
          <div class="form-group">
            <label>LINE Channel Access Token (Messaging API)</label>
            <input type="password" id="lineAccessToken" value="<?= config.lineAccessToken ?>"
              placeholder="eyJhbGciOiJIUzI1NiJ9...">
          </div>
          <div class="grid">
            <div class="form-group">
              <label>LINE Login Client ID (Channel ID)</label>
              <input type="text" id="lineClientId" value="<?= config.lineClientId ?>" placeholder="ä¾‹: 1234567890">
            </div>
            <div class="form-group">
              <label>LINE Login Client Secret</label>
              <input type="password" id="lineClientSecret" value="<?= config.lineClientSecret ?>">
            </div>
          </div>
        </div>
      </details>
    </section>

    <!-- 6. Test Operations -->
    <section>
      <h2 style="color: #fbbf24;">ğŸ§ª å‹•ä½œãƒ†ã‚¹ãƒˆ (å®‰å…¨ç¢ºèª)</h2>
      <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 1.5rem;">
        ä¿å­˜æ¸ˆã¿ã®è¨­å®šãŒæ­£ã—ãå‹•ãã‹ã€å®Ÿéš›ã«ä»–äººã«é€šçŸ¥ã‚’é€ã‚‰ãšã«ãƒ†ã‚¹ãƒˆã§ãã¾ã™ã€‚
      </p>
      <div class="grid">
        <div class="form-group">
          <button class="btn btn-outline" style="width: 100%;" onclick="runTest('verifyLineConnection')">
            <span>ğŸ“±</span> LINEé€£æºãƒ†ã‚¹ãƒˆ
          </button>
        </div>
        <div class="form-group">
          <button class="btn btn-outline" style="width: 100%;" onclick="runTest('simulateEmergencyTrigger')">
            <span>ğŸš¨</span> èµ·å‹•ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
          </button>
        </div>
        <div class="form-group">
          <button class="btn btn-outline" style="width: 100%;" onclick="runTest('simulateLastMessages')">
            <span>ğŸ“§</span> éºè¨€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é€ä¿¡
          </button>
        </div>
      </div>
      <div id="test-result" style="margin-top: 1rem; font-size: 0.85rem; color: #4ade80; display: none;"></div>
    </section>

    <div class="footer-actions">
      <button class="btn btn-accent btn-large" onclick="handleSave()" id="save-btn">
        <span>ğŸ’¾</span> è¨­å®šã‚’ä¿å­˜ã—ã¦é©ç”¨ã™ã‚‹
      </button>
    </div>
  </div>

  <div id="toast">ä¿å­˜ã•ã‚Œã¾ã—ãŸ</div>

  <script>
    const initialMessages = <?= JSON.stringify(config.lastMessages) ?>;

    function addMessageRow(data = { name: '', type: 'LINE', id: '', message: '' }) {
      const list = document.getElementById('messages-list');
      const div = document.createElement('div');
      div.className = 'message-item';
      div.innerHTML = `
        <button class="btn-remove" onclick="this.parentElement.remove()">âœ•</button>
        <div class="grid">
          <div class="form-group">
            <label>å®›å</label>
            <input type="text" class="msg-name" value="${data.name}" placeholder="ä¾‹: ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼">
          </div>
          <div class="form-group">
            <label>é€šçŸ¥æ‰‹æ®µ</label>
            <select class="msg-type">
              <option value="LINE" ${data.type === 'LINE' ? 'selected' : ''}>LINE</option>
              <option value="EMAIL" ${data.type === 'EMAIL' ? 'selected' : ''}>Email</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>é€ä¿¡å…ˆID / Email</label>
          <input type="text" class="msg-id" value="${data.id}" placeholder="LINE ID ã¾ãŸã¯ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
        </div>
        <div class="form-group" style="margin-bottom:0;">
          <label>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡</label>
          <textarea class="msg-content" rows="3" placeholder="æœ€æœŸã®è¨€è‘‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">${data.message}</textarea>
        </div>
      `;
      list.appendChild(div);
    }

    // Initialize with existing messages
    initialMessages.forEach(msg => addMessageRow(msg));

    function handleSave(callback) {
      const saveBtn = document.getElementById('save-btn');
      saveBtn.disabled = true;
      saveBtn.innerText = "ä¿å­˜ä¸­...";

      const messageItems = document.querySelectorAll('.message-item');
      const lastMessages = Array.from(messageItems).map(item => ({
        name: item.querySelector('.msg-name').value,
        type: item.querySelector('.msg-type').value,
        id: item.querySelector('.msg-id').value,
        message: item.querySelector('.msg-content').value
      }));

      const data = {
        passkey: document.getElementById('passkey').value,
        gracePeriodHours: document.getElementById('gracePeriodHours').value,
        macrodroidWebhookUrl: document.getElementById('macrodroidWebhookUrl').value,
        lastMessages: lastMessages,
        lineAccessToken: document.getElementById('lineAccessToken').value,
        lineClientId: document.getElementById('lineClientId').value,
        lineClientSecret: document.getElementById('lineClientSecret').value
      };

      google.script.run
        .withSuccessHandler((res) => {
          showToast(res.message);
          saveBtn.disabled = false;
          saveBtn.innerHTML = '<span>ğŸ’¾</span> è¨­å®šã‚’ä¿å­˜ã—ã¦é©ç”¨ã™ã‚‹';
          if (callback) callback();
        })
        .withFailureHandler((err) => {
          alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + err.message);
          saveBtn.disabled = false;
          saveBtn.innerHTML = '<span>ğŸ’¾</span> è¨­å®šã‚’ä¿å­˜ã—ã¦é©ç”¨ã™ã‚‹';
        })
        .saveSettings(data);
    }

    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.innerText = msg;
      toast.style.display = 'block';
      setTimeout(() => {
        toast.style.display = 'none';
      }, 3000);
    }

    function runTest(functionName) {
      const resultDiv = document.getElementById('test-result');
      resultDiv.style.display = 'block';
      resultDiv.style.color = '#94a3b8';
      resultDiv.innerText = 'ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...';

      google.script.run
        .withSuccessHandler((res) => {
          resultDiv.innerText = res.message;
          resultDiv.style.color = res.success ? '#4ade80' : '#ef4444';
          showToast("ãƒ†ã‚¹ãƒˆã‚’å®Œäº†ã—ã¾ã—ãŸ");
        })
        .withFailureHandler((err) => {
          resultDiv.innerText = "ã‚¨ãƒ©ãƒ¼: " + err.message;
          resultDiv.style.color = '#ef4444';
        })[functionName]();
    }

    function handleLogin() {
      showToast("LINEèªè¨¼ç”»é¢ã‚’æº–å‚™ä¸­...");
      google.script.run
        .withSuccessHandler((url) => {
          console.log("Redirecting to: " + url);
          window.top.location.replace(url);
        })
        .withFailureHandler((err) => {
          alert("èªè¨¼URLã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
        })
        .getLoginUrl();
    }

    function handleLogout() {
      if (confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
        google.script.run
          .withSuccessHandler((result) => {
            window.top.location.href = result.redirectUrl;
          })
          .withFailureHandler((err) => {
            alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
          })
          .logout();
      }
    }

    function handleChangeGoogleAccount() {
      if (confirm("Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å¤‰æ›´ã™ã‚‹ã«ã¯ä¸€åº¦ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã€‚\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
        google.script.run
          .withSuccessHandler((result) => {
            // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¾Œã«ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸é£›ã°ã™ã€‚ãã“ã«ã‚ã‚‹ã€Œã‚¢ã‚«ã‚¦ãƒ³ãƒˆå¤‰æ›´ã€ãƒœã‚¿ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã‚‚ã‚‰ã†ä»•çµ„ã¿
            window.top.location.href = result.redirectUrl;
          })
          .withFailureHandler((err) => {
            alert("å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + err.message);
          })
          .logout();
      }
    }
  </script>
</body>

</html>